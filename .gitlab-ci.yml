stages:
  - website_build-and-test
  - app_build-and-test
  - openapi_gen
  - openapi_deploy
  - deploy-k8s


openapi_gen:
  image: jeshan/swagger-codegen-cli
  stage: openapi_gen
  before_script:
    - apk update
    - apk add --update openssl
    - wget https://repo1.maven.org/maven2/org/openapitools/openapi-generator-cli/5.1.0/openapi-generator-cli-5.1.0.jar -O openapi-generator-cli.jar
  script:
    - 'java -jar openapi-generator-cli.jar generate -g kotlin -i Documents/ApiSpec/openapi.yaml -o openapi-kotlin-client --package-name edu.hm.digitaltourguide.api @Parcelize'
  only:
    refs:
      - openapi_parcelable
  artifacts:
    name: '${CI_JOB_NAME}_${CI_COMMIT_REF_NAME}'
    paths: ['openapi-kotlin-client']

openapi_deploy:
  stage: openapi_deploy
  before_script:
    - apk update
    - apk add git
    - apk add --update openssl
  script:
    - rm -r Frontend/App/DigitalTourGuide/app/src/main/java/edu/hm/digitaltourguide/api
    - mv openapi-kotlin-client/src/main/kotlin/edu/hm/digitaltourguide/api Frontend/App/DigitalTourGuide/app/src/main/java/edu/hm/digitaltourguide/api
    - git config --global user.name "${GITLAB_USER_NAME}"
    - git config --global user.email "${GITLAB_USER_EMAIL}"
    - git pull .
    - git add Frontend/App/DigitalTourGuide/app/src/main/java/edu/hm/digitaltourguide/api
    - git commit -m "Updated API Client" || if [ $? -eq 64 ]; then echo "success"; else echo $code; fi
    - git push https://${GITLAB_USER_LOGIN}:${TOKEN}@gitlab.lrz.de/swe2_ss2021/Gruppe02.git/ HEAD:openapi_parcelable -f
  only:
    refs:
      - openapi_parcelable
